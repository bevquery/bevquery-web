<body>
  <iframe id="appFrame"></iframe>

  <script>
    const WEBAPP_BASE = "https://script.google.com/macros/s/AKfycbxmA1RCxkkL2U4NhQKfH64RWYhM9QFd61YUANt2eBH4sh7bnnH7tFw5c8n8o5IDQxTg/exec";
    const STORAGE_KEY = "bevq_token"; // match your canonical key

    const frame = document.getElementById("appFrame");

    function buildUrlWithSid(token) {
      if (!token) return WEBAPP_BASE;
      return WEBAPP_BASE + "?sid=" + encodeURIComponent(token);
    }

    function loadFrameFromStoredToken() {
      let token = null;
      try { token = localStorage.getItem(STORAGE_KEY); } catch (e) {}
      frame.src = buildUrlWithSid(token);
    }

    // Initial load
    loadFrameFromStoredToken();

    // Receive token from iframe after login
    window.addEventListener("message", (ev) => {
      const data = ev.data || {};
      if (data.type === "AUTH_SUCCESS" && data.token) {
        try { localStorage.setItem(STORAGE_KEY, data.token); } catch (e) {}
        // Optional: keep iframe URL in sync so a hard refresh keeps working
        frame.src = buildUrlWithSid(data.token);
      }

      if (data.type === "LOGOUT") {
        try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
        frame.src = WEBAPP_BASE;
      }
    });
  </script>
</body>
